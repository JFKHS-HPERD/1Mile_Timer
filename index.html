<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple Runners Timer</title>
    <style>
        .runner {
            margin-bottom: 10px;
        }
        .runner-name {
            font-weight: bold;
        }
        .timer {
            font-size: 1.2em;
        }
        #startButton {
            background-color: green;
            color: white;
            padding: 10px;
        }
        .stopButton {
            background-color: red;
            color: white;
        }
        .doneButton {
            background-color: grey;
            color: white;
        }
        button {
            margin-left: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>

<h1>Multi-Runner Timer</h1>

<!-- Input field for Class Period -->
<label for="classPeriod">Class Period: </label>
<input type="text" id="classPeriod" placeholder="Enter class period">

<br><br>

<!-- Input field and button to add runners -->
<input type="text" id="runnerName" placeholder="Enter runner's name" />
<button id="addRunnerButton">Add Runner</button>

<!-- File input for importing list of runners -->
<input type="file" id="importRunnersFile" accept=".csv">
<button id="importRunnersButton">Import Runners</button>

<br><br>

<!-- Start, Reset Times, Reset List, and Export buttons -->
<button id="startButton">Start Race</button>
<button id="resetTimesButton">Reset Times</button>
<button id="resetListButton">Reset List</button>
<button id="exportCsvButton">Export to CSV</button>
<button id="exportTxtButton">Export to TXT</button>

<br><br>

<!-- Runner list in a table format -->
<table id="runnersTable">
    <thead>
        <tr>
            <th>Runner Name</th>
            <th>Timer</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <!-- Runner rows will be injected here -->
    </tbody>
</table>

<script>
    let runners = [];
    let startTime;
    let interval;

    // Function to render the list of runners
    function renderRunners() {
        const container = document.getElementById('runnersContainer');
        container.innerHTML = ''; // Clear previous content

        runners.forEach((runner, index) => {
            const runnerDiv = document.createElement('div');
            runnerDiv.classList.add('runner');

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('runner-name');
            nameSpan.textContent = runner.name;

            const timerSpan = document.createElement('span');
            timerSpan.classList.add('timer');
            timerSpan.id = `timer-${index}`;
            timerSpan.textContent = '00:00:00';

            const stopButton = document.createElement('button');
            stopButton.textContent = 'Stop';
            stopButton.addEventListener('click', () => stopTimer(index));

            runnerDiv.appendChild(nameSpan);
            runnerDiv.appendChild(timerSpan);
            runnerDiv.appendChild(stopButton);
            container.appendChild(runnerDiv);
        });
    }

    // Function to add a runner
    function addRunner(runnerName) {
        if (runnerName) {
            runners.push({ name: runnerName, time: null, isRunning: true });
            renderRunners();
        }
    }

    // Add runner via input field
    document.getElementById('addRunnerButton').addEventListener('click', () => {
        const runnerNameInput = document.getElementById('runnerName');
        const runnerName = runnerNameInput.value.trim();
        if (runnerName) {
            addRunner(runnerName);
            runnerNameInput.value = ''; // Clear input field
        }
    });

    // Import list of runners from CSV file
    document.getElementById('importRunnersButton').addEventListener('click', () => {
        const fileInput = document.getElementById('importRunnersFile');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                lines.forEach(line => {
                    const runnerName = line.trim();
                    if (runnerName) {
                        addRunner(runnerName);
                    }
                });
            };
            reader.readAsText(file);
        }
    });

    // Function to start the race
    function startRace() {
        if (runners.length === 0) {
            alert('Please add at least one runner before starting the race.');
            return;
        }
        
        // If a race is already running, stop it
        if (interval) {
            clearInterval(interval);  // Stop the previous timer
        }

        startTime = Date.now();  // Capture the new start time
        interval = setInterval(updateTimers, 100);  // Start updating the timers again
    }

    // Function to update the timers for each runner
    function updateTimers() {
        const currentTime = Date.now();
        runners.forEach((runner, index) => {
            if (runner.isRunning) {
                const elapsedTime = currentTime - startTime;
                document.getElementById(`timer-${index}`).textContent = formatTime(elapsedTime);
            }
        });
    }

    // Function to stop the timer for a specific runner
    function stopTimer(index) {
        if (runners[index].isRunning) {
            const currentTime = Date.now();
            const elapsedTime = currentTime - startTime;
            runners[index].time = elapsedTime;
            runners[index].isRunning = false;
            
            // Update the timer display
            document.getElementById(`timer-${index}`).textContent = formatTime(elapsedTime);
            
            // Change the "Stop" button to "Done"
            const stopButton = document.querySelectorAll('.runner')[index].querySelector('button');
            stopButton.textContent = 'Done';
            stopButton.disabled = true;
        }
    }

    // Function to format time (milliseconds to hh:mm:ss)
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    }

    // Function to reset only the timers
    function resetTimes() {
        clearInterval(interval);  // Stop the timers from updating

        runners.forEach((runner, index) => {
            runner.time = null;  // Reset the internal time
            runner.isRunning = true;  // Allow timers to start again
            document.getElementById(`timer-${index}`).textContent = '00:00:00';  // Reset display
            const stopButton = document.querySelectorAll('.runner')[index].querySelector('button');
            stopButton.textContent = 'Stop';  // Reset button text
            stopButton.disabled = false;  // Re-enable the stop button
        });

        startTime = null;  // Clear the start time
    }

    // Function to reset the list of runners
    function resetList() {
        clearInterval(interval);
        runners = [];
        renderRunners();
    }

    // Function to export data to CSV
    function exportToCsv() {
        const classPeriod = document.getElementById('classPeriod').value.trim();
        let fileName = classPeriod ? `runners_times_${classPeriod}.csv` : 'runners_times.csv';

        let csvContent = "data:text/csv;charset=utf-8,Name,Time\n";
        runners.forEach(runner => {
            if (!runner.isRunning && runner.time !== null) {
                csvContent += `${runner.name},${formatTime(runner.time)}\n`;
            }
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", fileName);
        document.body.appendChild(link); // Required for Firefox
        link.click();
        link.remove();
    }

    // Function to export data to a TXT file
    function exportToTxt() {
        const classPeriod = document.getElementById('classPeriod').value.trim();
        let fileName = classPeriod ? `runners_times_${classPeriod}.txt` : 'runners_times.txt';

        let txtContent = "Name\t\tTime\n";
        runners.forEach(runner => {
            if (!runner.isRunning && runner.time !== null) {
                txtContent += `${runner.name}\t\t${formatTime(runner.time)}\n`;
            }
        });

        const blob = new Blob([txtContent], { type: 'text/plain' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }

    // Event listeners for buttons
    document.getElementById('startButton').addEventListener('click', startRace);
    document.getElementById('resetTimesButton').addEventListener('click', resetTimes);
    document.getElementById('resetListButton').addEventListener('click', resetList);
    document.getElementById('exportCsvButton').addEventListener('click', exportToCsv);
    document.getElementById('exportTxtButton').addEventListener('click', exportToTxt);

    // Initialize the app by rendering any existing runners
    renderRunners();
</script>

</body>
</html>
